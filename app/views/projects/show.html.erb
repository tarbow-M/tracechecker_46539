<!-- データ表示・範囲選択ページ -->
<div class="max-w-7xl mx-auto p-4 sm:p-8">
  
  <!-- 1. ヘッダー (パンくずリストとタイトル) -->
  <div class="mb-4">
    <%= link_to "ダッシュボード", root_path, class: "text-blue-600 hover:underline" %>
    <span class="text-gray-500 mx-2">/</span>
    <%= link_to @parent_project.name, parent_project_path(@parent_project), class: "text-blue-600 hover:underline" %>
    <span class="text-gray-500 mx-2">/</span>
    <span class="font-semibold text-gray-800"><%= @project.name %></span>
  </div>

  <h1 class="text-3xl font-bold text-gray-900 mb-6">
    照合実行: <%= @project.name %>
  </h1>

  <!-- 2-1. ファイル選択エリア -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">1. 照合対象ファイルを選択</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- 資料Aの選択 -->
      <div>
        <label for="file_a_select" class="block text-sm font-medium text-gray-700 mb-2">資料A (比較元)</label>
        <select id="file_a_select" name="file_a" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
          <option value="">アップロード済みファイルから選択...</option>
          <% @files.each do |file| %>
            <option 
              value="<%= rails_blob_path(file) %>" 
              data-filename="<%= file.filename.to_s %>"
              data-blob-id="<%= file.blob.id %>">
              <%= file.filename.to_s %> (<%= number_to_human_size(file.blob.byte_size) %>)
            </option>
          <% end %>
        </select>
      </div>
      <!-- 資料Bの選択 -->
      <div>
        <label for="file_b_select" class="block text-sm font-medium text-gray-700 mb-2">資料B (比較先)</label>
        <select id="file_b_select" name="file_b" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
          <option value="">アップロード済みファイルから選択...</option>
           <% @files.each do |file| %>
            <option 
              value="<%= rails_blob_path(file) %>" 
              data-filename="<%= file.filename.to_s %>"
              data-blob-id="<%= file.blob.id %>">
              <%= file.filename.to_s %> (<%= number_to_human_size(file.blob.byte_size) %>)
            </option>
          <% end %>
        </select>
      </div>
    </div>
  </div>

  <!-- 2-2. 照合パターン選択 & 範囲指定 -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">2. 照合パターン選択 & 範囲指定</h2>
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
      <!-- テンプレート選択 -->
      <div class="w-full md:w-1/3">
        <label for="template_select" class="block text-sm font-medium text-gray-700 mb-1">照合パターン (テンプレート)</label>
        <select id="template_select" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option value="none">テンプレートを読み込む...</option>
          <!-- (JavaScript: loadTemplates() によって動的に挿入される) -->
        </select>
        <p class="mt-2 text-sm text-gray-500">
          <!-- TODO: テンプレート管理画面へのリンク -->
          <a href="#" class="text-blue-600 hover:underline">テンプレートを管理</a>
        </p>
      </div>

      <!-- 範囲指定モード -->
      <div class="w-full md:w-2/3 flex flex-col items-start md:items-end gap-2">
        <div id="selection-status" class="text-sm text-gray-600 w-full text-left md:text-right">
          <p>資料A: 0 セル選択中</p>
          <p>資料B: 0 セル選択中</p>
        </div>
        <div class="flex gap-2">
          <button id="reset-selection-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg">
            範囲指定リセット
          </button>
          <button id="toggle-selection-mode-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg">
            範囲指定モード開始
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 3. 比較プレビューエリア -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">3. 比較プレビュー</h2>
    <div id="comparison-area" class="comparison-area grid grid-cols-1 md:grid-cols-2 gap-6">
      
      <!-- 資料A プレビュー -->
      <div id="preview-A" class="doc-view bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 min-h-[400px] overflow-x-auto">
        <h3 id="preview-A-header" class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">資料A: (ファイル未選択)</h3>
        <table class="w-full text-sm text-left text-gray-500">
          <thead class="text-xs text-gray-700 uppercase bg-gray-100">
            <tr>
              <th scope="col" class="px-4 py-2">キー</th>
              <th scope="col" class="px-4 py-2">目標</th>
              <th scope="col" class="px-4 py-2">結果</th>
            </tr>
          </thead>
          <tbody id="table-A">
            <!-- (JavaScript: generatePreviewTable() によって動的に挿入される) -->
          </tbody>
        </table>
      </div>

      <!-- 資料B プレビュー -->
      <div id="preview-B" class="doc-view bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 min-h-[400px] overflow-x-auto">
        <h3 id="preview-B-header" class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">資料B: (ファイル未選択)</h3>
        <table class="w-full text-sm text-left text-gray-500">
          <thead class="text-xs text-gray-700 uppercase bg-gray-100">
            <tr>
              <th scope="col" class="px-4 py-2">キー</th>
              <th scope="col" class="px-4 py-2">目標</th>
              <th scope="col" class="px-4 py-2">結果</th>
            </tr>
          </thead>
          <tbody id="table-B">
            <!-- (JavaScript: generatePreviewTable() によって動的に挿入される) -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

  <!-- 2-3. 照合実行 -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">4. 照合実行</h2>
    <div class="flex justify-center">
      <button id="start-comparison-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md text-lg transition duration-150 ease-in-out">
        <svg class="w-6 h-6 inline-block mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z" clip-rule="evenodd" />
        </svg>
        照合実行
      </button>
    </div>
  </div>

  <!-- 2-4. 照合結果サマリー (初期状態では非表示) -->
  <div id="result-summary-section" class="hidden bg-white p-6 rounded-lg shadow-lg border-t-4 border-blue-500 mb-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">照合結果サマリー</h2>
    <div class="flex flex-col md:flex-row justify-between items-start gap-6">
      <!-- サマリー本文 -->
      <div id="summary-content" class="text-lg space-y-1">
        <!-- (JavaScript: startComparison() によって内容が挿入される) -->
      </div>
      <!-- 保存ボタン -->
      <div class="flex flex-col gap-3 w-full md:w-auto">
        <button id="export-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
          結果エクスポート (CSV)
        </button>
        <button id="save-template-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
          選択範囲をテンプレートに保存
        </button>
        <button id="save-archive-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
          証跡としてアーカイブ保存
        </button>
      </div>
    </div>
  </div>
  


<!-- モーダル定義 -->
<!-- 1. テンプレート保存モーダル -->
<div id="template-name-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 bg-gray-900 bg-opacity-50">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all">
    <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">テンプレートを保存</h3>
    <p class="mb-4 text-sm text-gray-600">現在の選択範囲（資料A: <span id="template-modal-count-a">0</span>セル, 資料B: <span id="template-modal-count-b">0</span>セル）を保存します。テンプレート名を入力してください。</p>
    <form id="template-name-form">
      <div class="mb-4">
        <label for="template-name" class="block text-sm font-medium text-gray-700 mb-1">テンプレート名</label>
        <input type="text" id="template-name" required class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border" placeholder="例: KPIサマリー (Q1 vs Q2)">
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeModal('template-name-modal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-medium">キャンセル</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium">保存</button>
      </div>
    </form>
  </div>
</div>

<!-- 2. アーカイブ保存モーダル -->
<div id="archive-name-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 bg-gray-900 bg-opacity-50">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all">
    <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">証跡としてアーカイブ保存</h3>
    <p class="mb-4 text-sm text-gray-600">現在の照合結果（差異: <span id="archive-modal-diff-count">0</span>件）を証跡として保存します。アーカイブ名を入力してください。</p>
    <form id="archive-name-form">
      <div class="mb-4">
        <label for="archive-name" class="block text-sm font-medium text-gray-700 mb-1">アーカイブ名</label>
        <input type="text" id="archive-name" required class="w-full border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 p-3 border" placeholder="例: 2025Q1_差異確定版">
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeModal('archive-name-modal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-medium">キャンセル</button>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium">保存・確定</button>
      </div>
    </form>
  </div>
</div>


<!-- 
  照合ロジックとUI制御のためのJavaScript 
-->
<style>
  /* (tailwind.config.js の safelist にも登録が必要) */
  .diff-highlight { background-color: #fecaca !important; } /* 赤 (差異) */
  .match-highlight { background-color: #d1fae5 !important; } /* 緑 (一致) */
  .unmatched-highlight { background-color: #fff3cd !important; } /* 黄 (片方のみ) */
  .template-highlight { background-color: rgba(191, 219, 254, 0.5) !important; } 
  .selection-mode-active .comparable-cell td { cursor: pointer; }
  .selection-mode-active .comparable-cell td:hover { background-color: rgba(222, 238, 255, 0.7) !important; }
  .comparison-cell-border { box-shadow: 0 0 0 2px #ef4444 inset !important; } /* 赤 (照合範囲) */
</style>

<script>
  // --- グローバル変数 (let -> var に変更) ---
  var isSelectionMode = false;
  var selectionCoordsA = [];
  var selectionCoordsB = [];
  var templatesCache = [];
  var comparisonResultsCache = [];
  var selectedFileAId = null;
  var selectedFileBId = null;
  var currentDiffCount = 0;

  // --- ダミーデータ (ERBからJSONとして埋め込む) ---
  // (const -> var に変更)
  var dummyDataA = <%= raw @dummy_data_a.to_json %>;
  var dummyDataB = <%= raw @dummy_data_b.to_json %>;

  // --- イベントリスナー登録 (Turboオフ対応) ---
  //  'turbo:load' -> 'DOMContentLoaded' 
  document.addEventListener('DOMContentLoaded', () => {
    
    console.log('TraceChecker JS (DOMContentLoaded) loaded.');

    // 1. 各種DOM要素の取得
    const selectA = document.getElementById('file_a_select');
    const selectB = document.getElementById('file_b_select');
    const templateSelect = document.getElementById('template_select');
    const toggleSelectionButton = document.getElementById('toggle-selection-mode-button');
    const resetSelectionButton = document.getElementById('reset-selection-button');
    const startComparisonButton = document.getElementById('start-comparison-button');
    
    // 2. テンプレート機能のセットアップ
    setupTemplateListeners();
    loadTemplates(); // 画面ロード時にテンプレート一覧を fetch

    // 3. アーカイブ機能のセットアップ
    setupArchiveButtonListener();

    // 4. ファイル選択・プレビュー機能のセットアップ
    if (selectA) selectA.addEventListener('change', () => updatePreview(selectA, 'A'));
    if (selectB) selectB.addEventListener('change', () => updatePreview(selectB, 'B'));
    
    // 初期ロード時にダミーデータを表示
    generatePreviewTable('A', dummyDataA);
    generatePreviewTable('B', dummyDataB);

    // 5. 範囲指定モードのセットアップ
    if (toggleSelectionButton) {
      toggleSelectionButton.addEventListener('click', toggleSelectionMode);
    }
    if (resetSelectionButton) {
      resetSelectionButton.addEventListener('click', resetSelection);
    }

    // 6. 照合実行機能のセットアップ
    if (startComparisonButton) {
      startComparisonButton.addEventListener('click', startComparison);
    }
    
    // 7. セル選択リスナーのセットアップ
    setupSelectionListeners();

    // ▼▼▼ 8. CSVエクスポート機能のセットアップ (新規追加) ▼▼▼
    const exportButton = document.getElementById('export-button');
    if (exportButton) {
      exportButton.addEventListener('click', exportResultsToCSV);
    }
    // ▲▲▲ 追加ここまで ▲▲▲
  });

  // ==========================================
  // 1. ファイル選択 & プレビュー機能
  // ==========================================

  // (generatePreviewTable を updatePreview より先に定義)
  function generatePreviewTable(docType, data) {
    // data が null や undefined の場合、空の配列として扱う
    const tableData = data || [];
    
    const tableBody = document.getElementById(`table-${docType}`);
    if (!tableBody) return;
    
    tableBody.innerHTML = ''; 
    
    tableData.forEach((row, rowIndex) => {
      const tr = document.createElement('tr');
      tr.classList.add('bg-white', 'border-b', 'comparable-cell');
      tr.dataset.docType = docType;
      tr.dataset.rowIndex = rowIndex;
      tr.dataset.key = row.key;
      
      const tdKey = document.createElement('td');
      tdKey.classList.add('px-4', 'py-2', 'font-medium', 'text-gray-900');
      tdKey.textContent = row.key;
      tdKey.dataset.colIndex = 0; 
      tdKey.dataset.coords = `${docType}:${rowIndex}:0`;
      tr.appendChild(tdKey);
      
      const tdGoal = document.createElement('td');
      tdGoal.classList.add('px-4', 'py-2');
      tdGoal.textContent = row.goal;
      tdGoal.dataset.colIndex = 1;
      tdGoal.dataset.coords = `${docType}:${rowIndex}:1`;
      tr.appendChild(tdGoal);

      const tdResult = document.createElement('td');
      tdResult.classList.add('px-4', 'py-2');
      tdResult.textContent = row.result;
      tdResult.dataset.colIndex = 2;
      tdResult.dataset.coords = `${docType}:${rowIndex}:2`;
      tr.appendChild(tdResult);

      tableBody.appendChild(tr);
    });
  }
  
  // (updatePreview 関数を修正)
  function updatePreview(selectEl, docType) {
    const selectedOption = selectEl.options[selectEl.selectedIndex];
    const filename = selectedOption.dataset.filename;
    const blobId = selectedOption.dataset.blobId;
    const h3 = document.getElementById(`preview-${docType}-header`);
    
    if (filename) {
      h3.textContent = `資料${docType}: ${filename}`;
      if (docType === 'A') {
        selectedFileAId = blobId; 
        // TODO: AJAXでファイル内容を読み込み、dummyDataA を置き換える
        // (現在はダミーデータを再描画)
        generatePreviewTable('A', dummyDataA);
      } else {
        selectedFileBId = blobId;
        // TODO: AJAXでファイル内容を読み込み、dummyDataB を置き換える
        // (現在はダミーデータを再描画)
        generatePreviewTable('B', dummyDataB);
      }
    } else {
      h3.textContent = `資料${docType}: (ファイル未選択)`;
      if (docType === 'A') {
         selectedFileAId = null;
         generatePreviewTable('A', []); // 空の配列でテーブルをクリア
      } else {
         selectedFileBId = null;
         generatePreviewTable('B', []); // 空の配列でテーブルをクリア
      }
    }
  }


  // ==========================================
  // 2. 範囲指定モード機能
  // ==========================================
  
  // (toggleSelectionMode 関数 バグ修正版)
  function toggleSelectionMode() {
    isSelectionMode = !isSelectionMode;
    const button = document.getElementById('toggle-selection-mode-button');
    const area = document.getElementById('comparison-area');
    
    if (isSelectionMode) {
      // --- モード開始 ---
      button.textContent = '範囲指定モード終了';
      button.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
      button.classList.add('bg-red-500', 'hover:bg-red-600');
      area.classList.add('selection-mode-active');
      
      // 照合結果(赤緑黄)と赤枠をリセット
      resetHighlights(); 
      // 選択範囲(青)もリセット
      selectionCoordsA = [];
      selectionCoordsB = [];
      updateSelectionStatus();
      
    } else {
      // --- モード終了 ---
      button.textContent = '範囲指定モード開始';
      button.classList.remove('bg-red-500', 'hover:bg-red-600');
      button.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
      area.classList.remove('selection-mode-active');
      
      // モード終了時は「青ハイライト」だけを消す
      // (selectionCoordsA/B のデータは「照合実行」のために保持する)
      document.querySelectorAll('.comparable-cell td.template-highlight').forEach(cell => {
        cell.classList.remove('template-highlight');
      });
      
      // (selectionCoordsA = [] などをここで実行すると
      // 照合実行時にデータが空になってしまうため、削除)
    }
  }


  function resetSelection() {
    selectionCoordsA = [];
    selectionCoordsB = [];
    document.querySelectorAll('.comparable-cell td').forEach(cell => {
      cell.classList.remove('template-highlight');
    });
    updateSelectionStatus();
  }

  function setupSelectionListeners() {
    const previewA = document.getElementById('preview-A');
    const previewB = document.getElementById('preview-B');

    const clickHandler = (e) => {
      if (!isSelectionMode) return; 
      
      const targetCell = e.target.closest('.comparable-cell td');
      if (!targetCell) return;
        
      const coords = targetCell.dataset.coords;
      const docType = targetCell.closest('.comparable-cell').dataset.docType;
      const key = targetCell.closest('.comparable-cell').dataset.key;
        
      const cellData = {
        coords: coords, 
        key: key,
        value: targetCell.textContent,
        row: parseInt(targetCell.closest('.comparable-cell').dataset.rowIndex, 10),
        col: parseInt(targetCell.dataset.colIndex, 10)
      };

      let selectionArray = (docType === 'A') ? selectionCoordsA : selectionCoordsB;
      const existingIndex = selectionArray.findIndex(c => c.coords === coords);
        
      if (existingIndex > -1) {
        selectionArray.splice(existingIndex, 1);
        targetCell.classList.remove('template-highlight');
      } else {
        selectionArray.push(cellData);
        targetCell.classList.add('template-highlight');
      }
      updateSelectionStatus();
    };
    
    if (previewA) previewA.addEventListener('click', clickHandler);
    if (previewB) previewB.addEventListener('click', clickHandler);
  }
  
  function updateSelectionStatus() {
    const statusDiv = document.getElementById('selection-status');
    if (statusDiv) {
      statusDiv.innerHTML = `
        <p>資料A: ${selectionCoordsA.length} セル選択中</p>
        <p>資料B: ${selectionCoordsB.length} セル選択中</p>
      `;
    }
  }

  // ==========================================
  // 3. テンプレート機能 (Fetch)
  // ==========================================

  function setupTemplateListeners() {
    const form = document.getElementById('template-name-form');
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const templateName = document.getElementById('template-name').value;
        const range = {
          a: selectionCoordsA.map(c => c.coords),
          b: selectionCoordsB.map(c => c.coords)
        };
        saveTemplate(templateName, range);
      });
    }
    
    const saveButton = document.getElementById('save-template-button');
    if (saveButton) {
      saveButton.addEventListener('click', () => {
        if (selectionCoordsA.length === 0 && selectionCoordsB.length === 0) {
          alert("範囲指定モードでセルを選択してください。");
          return;
        }
        document.getElementById('template-modal-count-a').textContent = selectionCoordsA.length;
        document.getElementById('template-modal-count-b').textContent = selectionCoordsB.length;
        openModal('template-name-modal');
      });
    }
    
    const select = document.getElementById('template_select');
    if (select) {
      select.addEventListener('change', (e) => {
        applyTemplate(e.target.value);
      });
    }
  }
  
  function loadTemplates() {
    const select = document.getElementById('template_select');
    if (!select) return;
    
    fetch('/templates')
      .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
      })
      .then(templates => {
        console.log('Templates loaded:', templates);
        templatesCache = templates; 
        select.options.length = 1; 
        
        templates.forEach(template => {
          const option = document.createElement('option');
          option.value = template.id;
          option.textContent = template.name;
          select.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Error loading templates:', error);
      });
  }

  function saveTemplate(templateName, range) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch('/templates', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      body: JSON.stringify({
        template: {
          name: templateName,
          range: { 
            a: range.a,
            b: range.b
          }
        }
      })
    })
    .then(response => response.json())
    .then(newTemplate => {
      if (newTemplate.errors) {
        alert('Error saving template: ' + newTemplate.errors.join(', '));
      } else {
        console.log('Template saved:', newTemplate);
        closeModal('template-name-modal');
        document.getElementById('template-name-form').reset();
        loadTemplates(); // プルダウンを再読み込み
      }
    })
    .catch(error => {
      console.error('Error saving template:', error);
    });
  }
  
  function applyTemplate(templateId) {
    resetSelection(); 
    if (templateId === 'none') return;
    
    const template = templatesCache.find(t => t.id == templateId);
    if (!template || !template.range) return;
    
    // template.range は { "a": ["A:0:1", ...], "b": ["B:0:2", ...] }
    const allCoords = (template.range.a || []).concat(template.range.b || []);
    
    allCoords.forEach(coordsStr => {
      const cell = document.querySelector(`td[data-coords="${coordsStr}"]`);
      if (cell) {
        cell.classList.add('template-highlight');
        
        const docType = cell.closest('.comparable-cell').dataset.docType;
        const selectionArray = (docType === 'A') ? selectionCoordsA : selectionCoordsB;
        selectionArray.push({
          coords: coordsStr,
          key: cell.closest('.comparable-cell').dataset.key,
          value: cell.textContent,
          row: parseInt(cell.closest('.comparable-cell').dataset.rowIndex, 10),
          col: parseInt(cell.dataset.colIndex, 10)
        });
      }
    });
    updateSelectionStatus();
  }


  // ==========================================
  // 4. 照合実行機能
  // ==========================================
  
  function startComparison() {
    console.log("照合実行 (デモ版ロジック)");
    
    if (selectionCoordsA.length === 0 || selectionCoordsB.length === 0) {
      alert("資料Aと資料Bの両方で、1セル以上の範囲指定（またはテンプレート適用）をしてください。");
      return;
    }
    
    // (青ハッチングだけリセット)
    document.querySelectorAll('.comparable-cell td.template-highlight').forEach(cell => {
      cell.classList.remove('template-highlight');
    });

    // (照合結果(赤緑黄)と赤枠をリセット)
    resetHighlights();
    
    const dataA = buildDataset(selectionCoordsA);
    const dataB = buildDataset(selectionCoordsB);
    
    // (赤枠を適用)
    applyComparisonBorder(selectionCoordsA);
    applyComparisonBorder(selectionCoordsB);
    
    comparisonResultsCache = [];
    currentDiffCount = 0;

    let diffCount = 0;
    let matchCount = 0;
    let unmatchedA = 0;
    let unmatchedB = 0;

    // Aを基準にBをチェック
    dataA.forEach((valueA, keyA) => {
      const cellA = valueA.cellRef; 
      
      if (dataB.has(keyA)) {
        const valueB = dataB.get(keyA);
        const cellB = valueB.cellRef;

        if (valueA.value === valueB.value) {
          applyHighlight(cellA, 'match-highlight');
          applyHighlight(cellB, 'match-highlight');
          matchCount++;
          comparisonResultsCache.push({
            key: keyA, flag: 'match', comment: null,
            target_cell: { a: cellA.dataset.coords, b: cellB.dataset.coords }
          });
        } else {
          applyHighlight(cellA, 'diff-highlight');
          applyHighlight(cellB, 'diff-highlight');
          diffCount++;
          comparisonResultsCache.push({
            key: keyA, flag: 'diff', comment: null,
            target_cell: { a: cellA.dataset.coords, b: cellB.dataset.coords }
          });
        }
      } else {
        applyHighlight(cellA, 'unmatched-highlight');
        unmatchedA++;
        comparisonResultsCache.push({
            key: keyA, flag: 'unmatched_a', comment: null,
            target_cell: { a: cellA.dataset.coords, b: null }
        });
      }
    });

    // Bを基準にAにないものをチェック
    dataB.forEach((valueB, keyB) => {
      const cellB = valueB.cellRef;
      if (!dataA.has(keyB)) {
        applyHighlight(cellB, 'unmatched-highlight');
        unmatchedB++;
        comparisonResultsCache.push({
            key: keyB, flag: 'unmatched_b', comment: null,
            target_cell: { a: null, b: cellB.dataset.coords }
        });
      }
    });

    const summaryContent = document.getElementById('summary-content');
    summaryContent.innerHTML = `
      <p class="text-red-600 font-semibold">差異: ${diffCount} 件</p>
      <p class="text-green-600">一致: ${matchCount} 件</p>
      <p class="text-yellow-700">資料Aのみ: ${unmatchedA} 件</p>
      <p class="text-yellow-700">資料Bのみ: ${unmatchedB} 件</p>
    `;
    document.getElementById('result-summary-section').classList.remove('hidden');
    currentDiffCount = diffCount;
  }
  
  function buildDataset(selectionCoords) {
    const dataMap = new Map();
    selectionCoords.forEach(cellData => {
      const key = cellData.key;
      const value = cellData.value;
      const cellRef = document.querySelector(`td[data-coords="${cellData.coords}"]`);
      
      if (!dataMap.has(key)) {
        dataMap.set(key, { value: value, cellRef: cellRef });
      }
    });
    return dataMap;
  }
  
  function applyComparisonBorder(selectionCoords) {
     selectionCoords.forEach(cellData => {
       const cell = document.querySelector(`td[data-coords="${cellData.coords}"]`);
       if(cell) cell.classList.add('comparison-cell-border');
     });
  }

  function applyHighlight(cellElement, highlightClass) {
    if(cellElement) cellElement.classList.add(highlightClass);
  }

  // (resetHighlights 関数 - 照合結果(赤緑黄)と赤枠のみリセット)
  function resetHighlights() {
    document.querySelectorAll('.comparable-cell td').forEach(cell => {
      cell.classList.remove(
        'diff-highlight', 
        'match-highlight', 
        'unmatched-highlight', 
        'comparison-cell-border'
        // 'template-highlight' はリセットしない (範囲指定は維持)
      );
    });
    
    // サマリーを隠し、キャッシュをリセット
    document.getElementById('result-summary-section').classList.add('hidden');
    currentDiffCount = 0;
    comparisonResultsCache = [];
    
    // (selectionCoordsA/B は「照合実行」のためにリセットしない)
  }
  
  // ==========================================
  // 5. アーカイブ機能 (Fetch)
  // ==========================================
  
  function setupArchiveButtonListener() {
    const form = document.getElementById('archive-name-form');
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const archiveName = document.getElementById('archive-name').value;
        saveArchive(archiveName);
      });
    }

    const saveButton = document.getElementById('save-archive-button');
    if (saveButton) {
      saveButton.addEventListener('click', () => {
        if (comparisonResultsCache.length === 0) {
          alert("先に「照合実行」ボタンを押して、照合結果を生成してください。");
          return;
        }
        if (!selectedFileAId || !selectedFileBId) {
          alert("資料Aと資料Bの両方を選択してください。");
          return;
        }
        
        document.getElementById('archive-modal-diff-count').textContent = currentDiffCount;
        openModal('archive-name-modal');
      });
    }
  }

  function saveArchive(archiveName) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    const archiveData = {
      name: archiveName,
      diff_count: currentDiffCount,
      file_a_id: selectedFileAId,
      file_b_id: selectedFileBId
    };
    const resultsData = comparisonResultsCache;
    const postUrl = '<%= parent_project_project_archived_results_path(@parent_project, @project) %>';

    fetch(postUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      body: JSON.stringify({
        archived_result: archiveData,
        results: resultsData
      })
    })
    .then(response => {
      // (サーバが 422 や 500 を返した場合)
      if (!response.ok) {
        // .json() を呼ぶ前に、テキストとしてエラーを先に確認する
        return response.text().then(text => {
           try {
             // JSONエラー (バリデーションエラーなど) の場合
             return JSON.parse(text);
           } catch (e) {
             // HTMLエラー (500 Internal Server Error など) の場合
             console.error("Server returned non-JSON error:", text);
             return { errors: ["サーバーで致命的なエラーが発生しました (500 Internal Server Error). Railsのログを確認してください。"] };
           }
        });
      }
      return response.json();
    })
    .then(data => {
      // ▼▼▼ 構文エラー ('T +) を修正 ▼▼▼
      if (data.errors) {
        alert('Error saving archive: ' + data.errors.join(', '));
      } else {
        console.log('Archive saved:', data);
        closeModal('archive-name-modal');
        document.getElementById('archive-name-form').reset();
        alert('証跡を保存しました！');
        
        // (コントローラから返されたURLに遷移)
        if (data.redirect_url) {
          window.location.href = data.redirect_url;
        } else {
          // (フォールバック)
          window.location.href = '<%= parent_project_path(@parent_project) %>';
        }
      }
    })
    .catch(error => {
      console.error('Error saving archive:', error);
      alert('証跡の保存中に致命的なエラーが発生しました。コンソールを確認してください。');
    });
  }

  // ==========================================
  // 6. ユーティリティ (モーダル)
  // ==========================================
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if(modal) modal.classList.remove('hidden');
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if(modal) modal.classList.add('hidden');
  }

  // 7. CSVエクスポート機能 
  function exportResultsToCSV() {
    console.log("Exporting results to CSV...");
    if (comparisonResultsCache.length === 0) { // ===：厳密等価演算子（型と値が一致）-> 何も入っていない時出力
      alert("先に「照合実行」ボタンを押して、照合結果を生成してください。");
      return;
    }

    let csvContent = "data:text/csv;charset=utf-8,";
    // ヘッダー行 (BOM + ヘッダー)
    // (Excel for Windows がUTF-8を正しく認識するために \uFEFF (BOM) を追加)
    csvContent += "\uFEFF" + "Key,Flag,Comment,TargetCell_A,TargetCell_B\r\n";

    comparisonResultsCache.forEach(row => {
      // CSVインジェクション対策 + カンマ/改行のエスケープ
      const sanitize = (str) => {
        if (str === null || str === undefined) return '""';
        let s = String(str);
        // ダブルクォートを2重にする
        s = s.replace(/"/g, '""');
        // カンマ、改行、ダブルクォートが含まれる場合は全体をダブルクォートで囲む
        if (s.search(/("|,|\n)/g) >= 0) {
          s = `"${s}"`;
        }
        return s;
      };

      const key = sanitize(row.key);
      const flag = sanitize(row.flag);
      const comment = sanitize(row.comment); // (現在は常にnull)
      const cellA = sanitize(row.target_cell.a);
      const cellB = sanitize(row.target_cell.b);
      
      let csvRow = [key, flag, comment, cellA, cellB].join(",");
      csvContent += csvRow + "\r\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    
    // ファイル名の生成
    const fileNameAEl = document.getElementById('file_a_select');
    const fileNameBEl = document.getElementById('file_b_select');
    
    const fileNameA = fileNameAEl.options[fileNameAEl.selectedIndex]?.dataset.filename || "fileA";
    const fileNameB = fileNameBEl.options[fileNameBEl.selectedIndex]?.dataset.filename || "fileB";
    const date = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    
    link.setAttribute("download", `TraceChecker_Result_${date}_${fileNameA}_vs_${fileNameB}.csv`);
    document.body.appendChild(link); // Required for FF

    link.click(); // This will download the data file
    document.body.removeChild(link);
  }

</script>