<!-- データ表示・範囲選択ページ -->
<div class="max-w-7xl mx-auto p-4 sm:p-8">
  
  <!-- 1. ヘッダー (パンくずリストとタイトル) -->
  <div class="mb-4">
    <%= link_to "業務一覧", root_path, class: "text-blue-600 hover:underline" %>
    <span class="text-gray-500 mx-2">/</span>
    <%= link_to @parent_project.name, parent_project_path(@parent_project), class: "text-blue-600 hover:underline" %>
    <span class="text-gray-500 mx-2">/</span>
    <span class="font-semibold text-gray-800"><%= @project.name %></span>
  </div>

  <h1 class="text-3xl font-bold text-gray-900 mb-6">
    照合実行: <%= @project.name %>
  </h1>

  <!-- 1-B. ロック警告 (is_locked が true の場合) -->
  <% if @project.is_locked? %>
    <div class="mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg shadow">
      <h3 class="font-bold text-lg">
        <svg class="w-6 h-6 inline-block mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
        </svg>
        照合結果ロック済み
      </h3>
      <p class="mt-1">この照合作業は「<%= @project.status || '確定済み' %>」として保存されているため、編集できません。
      
      <!-- ロック解除ボタン (Turboオフのため button_to に変更) -->
      <%= button_to '再確認モードへ移行', 
            unlock_parent_project_project_path(@parent_project, @project), 
            method: :patch,
            class: "mt-2 inline-block bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg text-sm" 
      %>
      </p>
    </div>
  <% end %>


  <!-- 2-1. ファイル選択エリア -->
  <!-- (is_locked が true の場合は disabled 属性を追加) -->
  <fieldset <%= 'disabled' if @project.is_locked? %>>
    <div class="bg-white p-4 rounded-lg shadow mb-6 <%= 'opacity-60' if @project.is_locked? %>">
      <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">1. 照合対象ファイルを選択</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 資料Aの選択 -->
        <div>
          <label for="file_a_select" class="block text-sm font-medium text-gray-700 mb-2">資料A (比較元)</label>
          <select id="file_a_select" name="file_a" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md disabled:bg-gray-100">
            <option value="">アップロード済みファイルから選択...</option>
            <% @files.each do |file| %>
              <option 
                value="<%= file.blob.id %>"
                <%= 'selected' if defined?(@selected_file_a_id) && @selected_file_a_id == file.blob.id %>
                data-filename="<%= file.filename.to_s %>"
                data-blob-id="<%= file.blob.id %>">
                <%= file.filename.to_s %> (<%= number_to_human_size(file.blob.byte_size) %>)
              </option>
            <% end %>
          </select>
        </div>
        <!-- 資料Bの選択 -->
        <div>
          <label for="file_b_select" class="block text-sm font-medium text-gray-700 mb-2">資料B (比較先)</label>
          <select id="file_b_select" name="file_b" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md disabled:bg-gray-100">
            <option value="">アップロード済みファイルから選択...</option>
             <% @files.each do |file| %>
              <option 
                value="<%= file.blob.id %>"
                <%= 'selected' if defined?(@selected_file_b_id) && @selected_file_b_id == file.blob.id %>
                data-filename="<%= file.filename.to_s %>"
                data-blob-id="<%= file.blob.id %>">
                <%= file.filename.to_s %> (<%= number_to_human_size(file.blob.byte_size) %>)
              </option>
            <% end %>
          </select>
        </div>
      </div>
    </div>
  </fieldset>


  <!-- 2-2. 照合パターン選択 & 範囲指定 -->
  <!-- (is_locked が true の場合は disabled 属性を追加) -->
  <fieldset <%= 'disabled' if @project.is_locked? %>>
    <div class="bg-white p-4 rounded-lg shadow mb-6 <%= 'opacity-60' if @project.is_locked? %>">
      <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">2. 過去の照合範囲を参照 & 範囲指定</h2>
      <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <!-- テンプレート選択 -->
        <div class="w-full md:w-1/3">
          <label for="template_select" class="block text-sm font-medium text-gray-700 mb-1">過去の照合範囲</label>
          <select id="template_select" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 disabled:bg-gray-100">
            <option value="none">過去の照合範囲を読み込む...</option>
            <!-- (JavaScript: loadTemplates() によって動的に挿入される) -->
          </select>
          <p class="mt-2 text-sm text-gray-500">
            <!-- TODO: テンプレート管理画面へのリンク -->
            <a href="#" class="text-blue-600 hover:underline">過去の照合範囲を管理</a>
          </p>
        </div>

        <!-- 範囲指定モード -->
        <div class="w-full md:w-2/3 flex flex-col items-start md:items-end gap-2">
          <div id="selection-status" class="text-sm text-gray-600 w-full text-left md:text-right">
            <%# <p id="key-selection-status" class="text-xs text-gray-500">キー選択: 資料A: 0 セル / 資料B: 0 セル</p> %>
            <p id="data-selection-status">データ範囲: 資料A: 0 セル / 資料B: 0 セル</p>
          </div>
          <div class="flex gap-2 flex-wrap justify-end">
            <%# <!-- キー選択ボタン -->
            <button id="toggle-key-selection-mode-button" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              キー選択モード開始
            </button>
            <button id="reset-key-selection-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              キー選択リセット
            </button> %>
            
            <!-- データ範囲選択ボタン (ドラッグ操作がメイン) -->
            <button id="toggle-selection-mode-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              データ範囲モード開始
            </button>
            <button id="reset-selection-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed">
              データ範囲リセット
            </button>
          </div>
        </div>
      </div>
    </div>
  </fieldset>

  <!-- 2-3. 照合実行 -->
  <!-- (ロックされている場合は非表示) -->
  <div class="bg-white p-4 rounded-lg shadow mb-6 <%= 'hidden' if @project.is_locked? %>">
    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">照合実行</h2>
    <div class="flex justify-center">
      <button id="start-comparison-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-md text-lg transition duration-150 ease-in-out">
        <svg class="w-6 h-6 inline-block mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v2.5h-2.5a.75.75 0 000 1.5h2.5v2.5a.75.75 0 001.5 0v-2.5h2.5a.75.75 0 000-1.5h-2.5v-2.5z" clip-rule="evenodd" />
        </svg>
        照合実行
      </button>
    </div>
  </div>


  <!-- 2-5. 照合結果 (初期状態では非表示) -->
  <div id="result-summary-section" class="hidden bg-white p-6 rounded-lg shadow-lg border-t-4 border-blue-500 mb-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">照合結果</h2>
    <div class="flex flex-col md:flex-row justify-between items-start gap-6">
      <!-- サマリー本文 -->
      <div id="summary-content" class="text-lg space-y-1">
        <!-- (JavaScript: startComparison() によって内容が挿入される) -->
      </div>
      <!-- 保存ボタン -->
      <div class="flex flex-col gap-3 w-full md:w-auto">
        <button id="export-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
          結果エクスポート (CSV)
        </button>
        
        <!-- (ロックされている場合は「引用照合エリア保存」ボタンを無効化) -->
        <button id="save-template-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md disabled:opacity-50 disabled:cursor-not-allowed" 
                <%= 'disabled' if @project.is_locked? %>>
          選択範囲を引用照合エリアとして保存
        </button>
        
        <!-- (ロック状態に応じてボタンを変更) -->
        <% if @project.is_locked? %>
          <!-- (ロック解除ボタンは 1-B に移動) -->
        <% else %>
          <button id="save-archive-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
            照合結果を保存
          </button>
        <% end %>
        
      </div>
    </div>
  </div> 

  <!-- 2.4 比較プレビューエリア -->
  <div class="bg-white p-4 rounded-lg shadow mb-6">
    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2 mb-4">3. 比較プレビュー</h2>
    <!-- (ロックされている場合はJavaScript(選択モード)を無効化) -->
    <div id="comparison-area" class="comparison-area grid grid-cols-1 md:grid-cols-2 gap-6 <%= 'selection-mode-disabled' if @project.is_locked? %>">
      
      <!-- 資料A プレビュー -->
      <div id="preview-A" class="doc-view bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 min-h-[400px] overflow-x-auto relative">
        <h3 id="preview-A-header" class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">資料A: (ファイル未選択)</h3>
        <table class="w-full text-sm text-left text-gray-500 table-auto">
          <thead class="text-xs text-gray-700 uppercase bg-gray-100">
            <tr>
              <th scope="col" colspan="3" class="px-4 py-2">
                (ファイルを選択してください)
              </th>
            </tr>
          </thead>
          <tbody id="table-A">
            <!-- (JavaScript: generatePreviewTable() によって動的に挿入される) -->
          </tbody>
        </table>
        <!-- ▼▼▼ 選択ボックス用コンテナ ▼▼▼ -->
        <div id="selection-overlay-A" class="absolute inset-0 pointer-events-none"></div>
      </div>

      <!-- 資料B プレビュー -->
      <div id="preview-B" class="doc-view bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-200 min-h-[400px] overflow-x-auto relative">
        <h3 id="preview-B-header" class="text-lg font-semibold text-gray-800 border-b pb-2 mb-3">資料B: (ファイル未選択)</h3>
        <table class="w-full text-sm text-left text-gray-500 table-auto">
          <thead class="text-xs text-gray-700 uppercase bg-gray-100">
             <tr>
              <th scope="col" colspan="3" class="px-4 py-2">
                (ファイルを選択してください)
              </th>
            </tr>
          </thead>
          <tbody id="table-B">
            <!-- (JavaScript: generatePreviewTable() によって動的に挿入される) -->
          </tbody>
        </table>
        <!-- ▼▼▼ 選択ボックス用コンテナ ▼▼▼ -->
        <div id="selection-overlay-B" class="absolute inset-0 pointer-events-none"></div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScriptに渡す動的設定値 -->
<script>
  window.traceCheckerConfig = {
    parentProjectId: <%= @parent_project.id %>,
    projectId: <%= @project.id %>,
    isProjectLocked: <%= @project.is_locked? ? 'true' : 'false' %>,
    filePreviewBasePath: "<%= file_preview_parent_project_path(@parent_project, file_id: 'FILE_ID_PLACEHOLDER') %>",
    archiveResultsPath: "<%= parent_project_project_archived_results_path(@parent_project, @project) %>",
    unlockProjectPath: "<%= unlock_parent_project_project_path(@parent_project, @project) %>"
  };
</script>

<!-- 照合エリア保存、影向結果保存モーダル（new/create作ってMVCモデルで作成すると内容が保存される前にページ移動することになりページの状態を容易に保てないためモーダルとして埋め込む） -->
<!-- 1. 照合エリア保存モーダル -->
<div id="template-name-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 bg-gray-900 bg-opacity-50">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all modal-content">
    <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">照合エリアを保存</h3>
    <form id="template-name-form">
      <!-- 1. 照合エリア名 -->
      <div class="mb-4">
        <label for="template-name" class="block text-sm font-medium text-gray-700 mb-1">照合エリア名</label>
        <input type="text" id="template-name" required class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border" placeholder="例: KPIサマリー (Q1 vs Q2)">
      </div>
      <p class="mb-4 text-sm text-gray-600">
        選択範囲: (資料A: <span id="template-modal-count-a">0</span>セル, 資料B: <span id="template-modal-count-b">0</span>セル)
      </p>

      <%# <!-- 2. 解釈ルール (Mapping) -->
      <div class="border-t pt-4">
        <h4 class="text-lg font-medium text-gray-800 mb-3">照合ルール (Mapping)</h4>
        
        <!-- 2a. キーの方向 -->
        <div class="mb-3">
          <label class="block text-sm font-medium text-gray-700 mb-2">キーの方向 (レイアウト)</label>
          <div class="flex gap-4">
            <label class="flex items-center">
              <input type="radio" id="mapping-orientation-column" name="mapping_orientation" value="column" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300" checked>
              <span class="ml-2 text-sm text-gray-700">縦レイアウト (キーが列にある)</span>
            </label>
            <label class="flex items-center">
              <input type="radio" id="mapping-orientation-row" name="mapping_orientation" value="row" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300">
              <span class="ml-2 text-sm text-gray-700">横レイアウト (キーが行にある)</span>
            </label>
          </div>
        </div>

        <!-- 2b. キーと値のインデックス (0始まり) -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label for="mapping-key-index" class="block text-sm font-medium text-gray-700 mb-1">キーの列/行 番号</label>
            <input type="number" id="mapping-key-index" value="0" min="0" required class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
            <p class="text-xs text-gray-500 mt-1">(0始まり。例: A列/1行目 = 0)</p>
          </div>
          <div>
            <label for="mapping-value-index" class="block text-sm font-medium text-gray-700 mb-1">値の列/行 番号</label>
            <input type="number" id="mapping-value-index" value="1" min="0" required class="w-full border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
            <p class="text-xs text-gray-500 mt-1">(0始まり。例: B列/2行目 = 1)</p>
          </div>
        </div>
      </div> %>
      
      <!-- 3. フォームボタン -->
      <div class="flex justify-end space-x-3 mt-6 border-t pt-4">
        <button type="button" onclick="closeModal('template-name-modal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-medium">キャンセル</button>
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium">保存</button>
      </div>
    </form>
  </div>
</div>

<!-- 2. 結果保存モーダル -->
<div id="archive-name-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 bg-gray-900 bg-opacity-50">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all modal-content">
    <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">結果保存</h3>
    <p class="mb-4 text-sm text-gray-600">現在の照合結果（差異: <span id="archive-modal-diff-count">0</span>件）を保存します。照合結果名を入力してください。</p>
    <form id="archive-name-form">
      <div class="mb-4">
        <label for="archive-name" class="block text-sm font-medium text-gray-700 mb-1">照合結果名</label>
        <input type="text" id="archive-name" required class="w-full border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-green-500 p-3 border" placeholder="例: 2025Q1_差異確定版">
      </div>
      <div class="flex justify-end space-x-3">
        <button type="button" onclick="closeModal('archive-name-modal')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-medium">キャンセル</button>
        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-medium">保存・確定</button>
      </div>
    </form>
  </div>
</div>


<!-- 照合ロジックとUI制御のためのスタイルとJavaScript -->
<style>
  /* (tailwind.config.js の safelist にも登録が必要) */ /* スタイルはHTMLに残します */
  .diff-highlight { background-color: #fecaca !important; } /* 赤 (差異) */
  .match-highlight { background-color: #d1fae5 !important; } /* 緑 (一致) */
  .unmatched-highlight { background-color: #fff3cd !important; } /* 黄 (片方のみ) */
  .template-highlight { background-color: rgba(191, 219, 254, 0.5) !important; } 
  .key-highlight { background-color: rgba(255, 237, 213, 0.7) !important; border: 1px solid #fb923c !important; } /* オレンジ (キー選択) */
  
  /* ▼▼▼ 範囲指定モード時のカーソルは comparison-area に依存 ▼▼▼ */
  .selection-mode-active .comparable-cell td,
  .selection-mode-active .comparable-cell th { cursor: crosshair !important; }
  .selection-mode-active .comparable-cell td:hover,
  .selection-mode-active .comparable-cell th:hover { background-color: rgba(222, 238, 255, 0.7) !important; }
  .comparison-cell-border { box-shadow: 0 0 0 2px #ef4444 inset !important; } /* 赤 (照合範囲) */
 </style>